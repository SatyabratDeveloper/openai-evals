import evals
import evals.metrics
import random
import openai
from evals.record import record_each_sample_match

openai.api_key = ""


class PromptTest(evals.Eval):
    def __init__(self, test_jsonl, **kwargs):
        super().__init__(**kwargs)
        self.test_jsonl = test_jsonl
        self.prompt_accuracy = 0
        self.prompt_subject_accuracy = 0
        self.correct_level_1 = 0

    def run(self, recorder):
        test_samples = evals.get_jsonl(self.test_jsonl)
        test_samples_length = len(test_samples)
        self.eval_all_samples(recorder, test_samples)

        prompt_accuracy = self.prompt_accuracy / test_samples_length
        prompt_subject_accuracy = self.prompt_subject_accuracy / test_samples_length
        prompt_correct_level_1 = self.correct_level_1

        file_accuracy = f"prompt_accuracy: {prompt_accuracy}\nprompt_subject_accuracy: {prompt_subject_accuracy}\nprompt_correct_level_1: {prompt_correct_level_1}\n"

        with open('evals_output.txt', 'a') as file:
            file.write(f"\n\n################################################\n")
            file.write(file_accuracy)
            file.write(f"################################################\n")

        print(f"file_accuracy: {file_accuracy}")


    def eval_sample(self, test_sample, rng: random.Random):
        # system_input = {"role": "system", "content": "As an educator responsible for classifying and identifying tags for questions in Indian competitive examinations, your goal is to add a subject tag and delve into the hierarchical topics and sub-topics of the questions. You should provide three levels of tags: Level 1, Level 2, and Level 3, in JSON format, structured as follows: {\"Level 1\": \"Subject tag\", \"Level 2\": \"Topic Tag\", \"Level 3\": \"Sub-Topic Tag\"}. For example: {\"Level 1\": \"Numerical Aptitude\", \"Level 2\": \"Series\", \"Level 3\": \"Arithmetic Progression\"}. You should select the subject tag only from the list of 'Subject-Tags' provided: ['History', 'Information and Communication Technology', 'Judiciary and Law', 'Legal Reasoning', 'Mathematics', 'Numerical Aptitude', 'Physics', 'Polity', 'Reasoning', 'Static General Knowledge', 'Geography', 'Strategic Management', 'Teaching Methodology', 'Agriculture', 'Aviation', 'Accountancy', 'Indian Art and Culture', 'Statistics', 'Biology', 'Business Management', 'Child development and pedagogy', 'Disaster Management', 'Economy', 'Financial Management', 'General Awareness', 'Chemistry', 'English', 'Environment']. To identify subject tags accurately, consider the following criteria: Mathematics: This subject encompasses a wide range of mathematical concepts, theories, and principles, including both practical and abstract mathematics. It involves advanced topics that require a deep understanding of mathematical theory and principles. Questions in this category typically include advanced mathematical calculations, proofs, and abstract mathematical concepts. Numerical Aptitude: Numerical aptitude tests primarily assess practical numerical skills. Questions in this category involve arithmetic calculations, percentages, ratios, data interpretation, and solving numerical word problems. These tasks are usually of moderate complexity and focus on basic to intermediate mathematical operations without requiring advanced mathematical theory. Reasoning: Reasoning tests evaluate logical and analytical thinking skills. They include tasks such as logical puzzles, pattern recognition, deciphering a code language, deductive reasoning, analogies, and abstract reasoning. Unlike mathematics, reasoning questions do not involve mathematical calculations but instead emphasize problem-solving and logical deduction. English Language: The English subject involves language proficiency and comprehension. Questions typically revolve around reading passages, correcting sentences, identifying synonyms and antonyms, assessing comprehension, and evaluating writing skills. It focuses on language usage, grammar, and reading comprehension, distinct from mathematical or logical content. General Awareness: General awareness questions cover a broad spectrum of topics, including current affairs, history, geography, science, politics, culture, and more. They assess a candidate's knowledge and awareness of various subjects. Unlike the other categories, general awareness does not require mathematical or logical reasoning but relies on factual knowledge. Please provide subject tags only from the list of 'Subject-Tags' provided, inside double quotes. Do not provide answers to specific questions."}

        # system_input = {"role": "system", "content": "As an educator responsible for classifying and identifying tags for questions in Indian competitive examinations, your goal is to add a subject tag and delve into the hierarchical topics and sub-topics of the questions. You should provide three levels of tags: Level 1, Level 2, and Level 3, in JSON format, structured as follows: {\"Level 1\": \"Subject tag\", \"Level 2\": \"Topic Tag\", \"Level 3\": \"Sub-Topic Tag\"}. For example: {\"Level 1\": \"Numerical Aptitude\", \"Level 2\": \"Series\", \"Level 3\": \"Arithmetic Progression\"}. To minimize confusion between subjects, you should select the subject tag only from the list of 'Subject-Tags' provided, which are: ['History', 'Information and Communication Technology', 'Judiciary and Law', 'Legal Reasoning', 'Mathematics', 'Numerical Aptitude', 'Physics', 'Polity', 'Reasoning', 'Static General Knowledge', 'Geography', 'Strategic Management', 'Teaching Methodology', 'Agriculture', 'Aviation', 'Accountancy', 'Indian Art and Culture', 'Statistics', 'Biology', 'Business Management', 'Child development and pedagogy', 'Disaster Management', 'Economy', 'Financial Management', 'General Awareness', 'Chemistry', 'English', 'Environment']. To identify subject tags accurately, consider the following refined criteria: Mathematics: This subject encompasses a wide range of advanced mathematical concepts, theories, and principles, including both practical and abstract mathematics. Questions in this category typically involve complex mathematical calculations, proofs, and abstract mathematical concepts. Numerical Aptitude: Numerical aptitude tests primarily assess practical numerical skills, including arithmetic calculations, percentages, ratios, data interpretation, and solving numerical word problems. Questions in this category focus on basic to intermediate mathematical operations. Reasoning: Reasoning tests evaluate logical and analytical thinking skills. They include tasks such as logical puzzles, pattern recognition, deciphering a code language, deductive reasoning, analogies, and abstract reasoning. Unlike mathematics, reasoning questions do not involve mathematical calculations but emphasize problem-solving and logical deduction. English Language: The English subject involves language proficiency and comprehension. Questions typically revolve around reading passages, correcting sentences, identifying synonyms and antonyms, assessing comprehension, and evaluating writing skills. It focuses on language usage, grammar, and reading comprehension, distinct from mathematical or logical content. General Awareness: General awareness questions cover a broad spectrum of topics, including current affairs, history, geography, science, politics, culture, and more. They assess a candidate's knowledge and awareness of various subjects. Unlike the other categories, general awareness does not require mathematical or logical reasoning but relies on factual knowledge. By refining the criteria and providing clear distinctions between subjects, you can minimize confusion and improve the accuracy of subject classification in the context of competitive examinations. Please provide subject tags only from the list of 'Subject-Tags' provided, inside double quotes. Do not provide answers to specific questions."}


        # Please provide subject tags based on the predominant content and context of the question, and use your discretion for questions that do not fit into a single subject category.

        # 81 correct
        # system_input = {"role": "system", "content": "As an educator responsible for classifying and identifying tags for questions in Indian competitive examinations, your goal is to add a subject tag and delve into the hierarchical topics and sub-topics of the questions. You should provide three levels of tags: Level 1, Level 2, and Level 3, in JSON format, structured as follows: {\"Level 1\": \"Subject tag\", \"Level 2\": \"Topic Tag\", \"Level 3\": \"Sub-Topic Tag\"}. For example: {\"Level 1\": \"Numerical Aptitude\", \"Level 2\": \"Series\", \"Level 3\": \"Arithmetic Progression\"}. To minimise confusion between subjects, you should select the subject tag only from the list of 'Subject-Tags' provided, which are: ['History', 'Information and Communication Technology', 'Judiciary and Law', 'Legal Reasoning', 'Mathematics', 'Numerical Aptitude', 'Physics', 'Polity', 'Reasoning', 'Static General Knowledge', 'Geography', 'Strategic Management', 'Teaching Methodology', 'Agriculture', 'Aviation', 'Accountancy', 'Indian Art and Culture', 'Statistics', 'Biology', 'Business Management', 'Child development and pedagogy', 'Disaster Management', 'Economy', 'Financial Management', 'General Awareness', 'Chemistry', 'English', 'Environment']. To identify subject tags accurately, consider the following refined criteria and specific keywords: Mathematics: This subject encompasses a wide range of advanced mathematical concepts, theories, and principles, including both practical and abstract mathematics. Questions in this category typically involve complex mathematical calculations, proofs, and abstract mathematical concepts. Numerical Aptitude: Numerical aptitude tests primarily assess practical numerical skills. Questions in this category focus on basic to intermediate mathematical operations. Numerical Aptitude keywords: number system, LCM and HCF, divisibility, numbers and decimal fractions, geometry, mensuration, 2D, 3D, compound interest, simple interest, area, shapes and perimeter, percentages, allegations and mixtures, ratios and proportion, partnership, time and work, speed, time and distance, boat and stream, train, profit and loss, average, equation, age, ages, probability, algebra, clock and calendar, series, progression, mean, median, mode, variance, and standard deviation, pie charts, tabular data interpretation, graphical data interpretation, simplification, and approximation. Reasoning: Reasoning tests evaluate logical and analytical thinking skills. Unlike mathematics, reasoning questions do not involve mathematical calculations but emphasise problem-solving and logical deduction. Reasoning keywords: series, alphanumeric series, position, analogies, artificial language, blood relations, calendars, cause and effect, clocks, coding and decoding, critical path, cube and cuboid, data sufficiency, decision making, deductive reasoning/statement analysis, dices, directions, figure matrix, input and output, mirror and water images, odd one out, picture series and sequences, paper folding, puzzles, pattern series and sequences, order and ranking, seating arrangements, shape construction, statement and assumptions, statement and conclusions, and syllogism. English: The English subject involves language proficiency and comprehension. Questions typically revolve around reading passages, correcting sentences, identifying synonyms and antonyms, assessing comprehension, and evaluating writing skills. It focuses on language usage, grammar, and reading comprehension, distinct from mathematical or logical content. English keywords: reading comprehension, cloze test, fill in the blanks, tenses rules, rearrangement, jumbled sentences, jumbled words, error detection, preposition rules, paragraph completion, idioms and phrases, meaningful sentences, essay writing, and letter writing. General Awareness: General awareness questions cover a broad spectrum of topics, including current affairs, history, geography, science, politics, culture, and more. They assess a candidate's knowledge and awareness of various subjects. Unlike the other categories, general awareness does not require mathematical or logical reasoning but relies on factual knowledge. Additionally, for questions that involve logical reasoning, deductive analysis, and problem-solving without direct mathematical calculations, you should classify them under the 'Reasoning' subject tag. These questions assess a candidate's logical and analytical thinking skills and do not require mathematical or numerical operations. Here are some example questions that fall under the 'Reasoning' subject tag: 1. A and B start from the same point. A cycle 10 km South, then turns to her right and cycles 2 km. B cycles 2 km North, then turns West and cycles 15 km, then turns to her left and cycles 12 km. Where is B with respect to A now? 2. In a line of boys Aman is 12th from the top and Baman is 18th from the bottom. If there are 6 boys between Aman and Baman, then how many boys are there in the row? 3. Arrange the given words in the sequence in which they occur in the dictionary: 1. Ropped 2. Roster 3. Roasted 4. Road 5. Roller 4. Six years ago Parvez's age was the same as the present age of Manish. If the present age of Parvez is one-fourth more than that of Manish's present age, then in how many years will Parvez's age become double of Manish's present age? 5. If 2 # 3 = 6; 15 # 3 = 2; 60 # 4 = 32; then what is the value of 27 # 3 = ? Please provide subject tags only from the list of 'Subject-Tags' provided, inside double quotes in JSON format only. Do not provide answers to specific questions."}

        # 83 correct
        system_input = {"role": "system", "content": "As an educator responsible for classifying and identifying tags for questions in Indian competitive examinations, your goal is to add a subject tag and delve into the hierarchical topics and sub-topics of the questions. You should provide three levels of tags: Level 1, Level 2, and Level 3, in JSON format, structured as follows: {\"Level 1\": \"Subject tag\", \"Level 2\": \"Topic Tag\", \"Level 3\": \"Sub-Topic Tag\"}. For example: {\"Level 1\": \"Numerical Aptitude\", \"Level 2\": \"Series\", \"Level 3\": \"Arithmetic Progression\"}. You should select the subject tag only from the list of 'Subject-Tags' provided, which are: ['History', 'Information and Communication Technology', 'Judiciary and Law', 'Legal Reasoning', 'Mathematics', 'Numerical Aptitude', 'Physics', 'Polity', 'Reasoning', 'Static General Knowledge', 'Geography', 'Strategic Management', 'Teaching Methodology', 'Agriculture', 'Aviation', 'Accountancy', 'Indian Art and Culture', 'Statistics', 'Biology', 'Business Management', 'Child development and pedagogy', 'Disaster Management', 'Economy', 'Financial Management', 'General Awareness', 'Chemistry', 'English', 'Environment']. To identify subject tags accurately, consider the following criteria and specific keywords: Mathematics: This subject encompasses a wide range of advanced mathematical concepts, theories, and principles, including both practical and abstract mathematics. Questions in this category typically involve complex mathematical calculations, proofs, and abstract mathematical concepts. Numerical Aptitude: Numerical aptitude tests primarily assess practical numerical skills. Questions in this category focus on basic to intermediate mathematical operations. Numerical Aptitude keywords: number system, LCM and HCF, divisibility, decimal fractions, geometry, mensuration, compound interest, simple interest, area, shapes and perimeter, percentage, allegation and mixture, ratio and proportion, partnership, time and work, speed, time and distance, boat and stream, train, profit and loss, average, equation, age, probability, algebra, clock and calendar, series, progression, mean, median, mode, variance, and standard deviation, pie charts, tabular data interpretation, graphical data interpretation, simplification, and approximation. Reasoning: Reasoning tests evaluate logical and analytical thinking skills. Unlike mathematics, reasoning questions do not involve mathematical calculations but emphasise problem-solving and logical deduction. Reasoning keywords: series, alphanumeric series, position, analogies, artificial language, blood relation, calendar, cause and effect, clock, coding, decoding, critical path, cube and cuboid, data sufficiency, decision making, deductive/statement analysis, dice, direction, figure matrix, input and output, odd one out, picture series/sequences, paper folding, puzzles, pattern series/sequences, order and ranking, seating arrangement, statement and assumption, statement and conclusion, and syllogism. English: The English subject involves language proficiency and comprehension. Questions typically revolve around reading passages, correcting sentences, identifying synonyms and antonyms, assessing comprehension, and evaluating writing skills. It focuses on language usage, grammar, and reading comprehension, distinct from mathematical or logical content. English keywords: reading comprehension, cloze test, fill in the blanks, tenses rules, rearrangement, jumbled sentences/words, error detection, preposition rules, paragraph completion, idioms and phrases, meaningful sentences. Generally, the subject tag of a question that is related to the passage and rearrangement of a sentence/passage is English. General Awareness: General awareness questions cover a broad spectrum of topics, including current affairs, history, geography, science, politics, culture, and more. They assess a candidate's knowledge and awareness of various subjects. Unlike the other categories, general awareness does not require mathematical or logical reasoning but relies on factual knowledge. Additionally, for questions that involve logical reasoning, deductive analysis, and problem-solving without direct mathematical calculations, you should classify them under the 'Reasoning' subject tag. These questions assess a candidate's logical and analytical thinking skills and do not require mathematical or numerical operations. Here are some example questions that fall under the 'Reasoning' subject tag: 1. A and B start from the same point. A cycle 10 km South, then turns to her right and cycles 2 km. B cycles 2 km North, then turns West and cycles 15 km, then turns to her left and cycles 12 km. Where is B with respect to A now? 2. In a line of boys Aman is 12th from the top and Baman is 18th from the bottom. If there are 6 boys between Aman and Baman, then how many boys are there in the row? 3. In a row of 74 girls, Shweta is 27th from the left end. Palak is 7th to the right of Shweta. What is Palak�s position from the right end of the row? 4. Select the correct alternative to indicate the arrangement of the following words in a logical and meaningful order. 5. Six years ago Parvez's age was the same as the present age of Manish. If the present age of Parvez is one-fourth more than that of Manish's present age, then in how many years will Parvez's age become double of Manish's present age? 6. If 2 # 3 = 6; 15 # 3 = 2; 60 # 4 = 32; then what is the value of 27 # 3 = ? 7. In a certain code language, �+� represents �ג, ��� represents �+�, �ג represents ��� and ��� represents ���. What is the answer to the following question? To further assist you in identifying the subject tag, consider the instructions provided within each question. In many cases, you can determine the subject tag by following the instructions and the nature of the question itself. These added instructions emphasize the importance of considering the question's instructions and nature when determining the subject tag. Please provide subject tags only from the list of 'Subject-Tags' provided, inside double quotes in JSON format only. Do not provide answers to specific questions."}

        # system_input = {"role": "system", "content": "As an educator responsible for classifying and identifying tags for questions in Indian competitive examinations, your goal is to add a subject tag and delve into the hierarchical topics and sub-topics of the questions. You should provide three levels of tags: Level 1, Level 2, and Level 3, in JSON format, structured as follows: {\"Level 1\": \"Subject tag\", \"Level 2\": \"Topic Tag\", \"Level 3\": \"Sub-Topic Tag\"}. For example: {\"Level 1\": \"Numerical Aptitude\", \"Level 2\": \"Series\", \"Level 3\": \"Arithmetic Progression\"}. To ensure accurate identification of the subject tag for each question, it is essential to carefully consider the question's instructions and nature. The instructions within each question can often provide valuable clues to determine the subject tag accurately. You should select the subject tag only from the list of 'Subject-Tags' provided, which are: ['History', 'Information and Communication Technology', 'Judiciary and Law', 'Legal Reasoning', 'Mathematics', 'Numerical Aptitude', 'Physics', 'Polity', 'Reasoning', 'Static General Knowledge', 'Geography', 'Strategic Management', 'Teaching Methodology', 'Agriculture', 'Aviation', 'Accountancy', 'Indian Art and Culture', 'Statistics', 'Biology', 'Business Management', 'Child development and pedagogy', 'Disaster Management', 'Economy', 'Financial Management', 'General Awareness', 'Chemistry', 'English', 'Environment']. To identify subject tags accurately, consider the following keywords for each subject: 1. Numerical Aptitude: number system, LCM and HCF, divisibility, decimal fractions, geometry, mensuration, compound interest, simple interest, discount, area, shapes and perimeter, percentage, allegation and mixture, ratio and proportion, partnership, time and work, speed, time and distance, boat and stream, train, profit and loss, average, equation, age, probability, algebra, clock and calendar, series, progression, mean, median, mode, variance, and standard deviation, pie charts, tabular data interpretation, graphical data interpretation, simplification, approximation, circle, quadrilateral. 2. Reasoning: series, alphanumeric series, pattern series, pattern sequences, picture series, picture sequences, logical and meaningful order, figure matrix, paper folding, position, age, ages, present age, analogies, blood relation, calendar, cause and effect, clock, coding, decoding, code language, critical path, cube and cuboid, data sufficiency, decision making, dice, direction, input and output, odd one out, position, puzzles, order and ranking, seating arrangement, Arrange, statement and assumption, statement and conclusion, syllogism. 3. English: reading comprehension, paragraph completion, paragraph, passage, read the following passage, cloze test, fill in the blanks, tenses rules, rearrangement, rearrange, rearranged, correct sequence, correct order, jumbled sentences, jumbled words, error detection, preposition rules, idioms and phrases, meaningful sentences. Your first step is to identify the subject tag by carefully analyzing the question's instructions and context. Please provide subject tags only from the list of 'Subject-Tags' provided, inside double quotes in JSON format only. Do not provide answers to specific questions."}

        user_input = test_sample["input"]
        prompt = [system_input, user_input]
        result = self.completion_fn(
            prompt=prompt,
            max_tokens=500
        )
        response = result.get_completions()[0]
        expected = test_sample["ideal"]

        sample_accuracy = evals.metrics.get_each_sample_accuracy(response, expected, user_input)

        self.prompt_accuracy += sample_accuracy["combined_tag_score"]
        self.prompt_subject_accuracy += sample_accuracy["subject_tags_score"]
        self.correct_level_1 += 1 if sample_accuracy["correct_level_1"] == True else 0
